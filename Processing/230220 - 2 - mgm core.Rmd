---
title: "230220 - 2.mgm"
output: html_document
date: "2023-20-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(pacman)
p_load(tidyverse, janitor, here, haven, labelled, sjmisc, skimr, ggplot2, jtools,
       stargazer, IsingFit, qgraph, Matrix, igraph, NetworkComparisonTest, bootnet,
       rio, IsingSampler, compute.es, foreign, mgm, matrixcalc, openxlsx, RColorBrewer)
```

# Input

```{r}
W3 = readRDS((here("Input", "W3_core.rds")))
```

# Processing

## Network objects

```{r}
## network objects
type <-c("g","g","c","g","g","g","g","g","g","g","g","g","c","c","g","c",
         "g","c","c")


level <-c("1","1","2","1","1","1","1","1","1","1","1","1","2","2","1","2",
         "1","2","2")

shortnames <- c(
"vac_bad", "risk", "conspiracy", "nat", "h_locus", "he_eco", "PTV_L",
"PTV_5SM", "PTV_BOI", "tr_sci", "tr_h", "pray", "media", "sex", "age",
"educ", "reg", "eco_insec", "hesitancy")

longnames <- c(
"Vaccine bad for health", "Risk perception", "Origin of virus", "Naturopaty",
"Health locus of control", "Public health vs economy", "Propensity to vote for L",
"Propensity to vote for 5SM", "Propensity to vote for BOI", "Trust in science",
"trust in health syst", "religion, pray", "media", "Sex", "Age", "Education",
"rural region", "Economic insecurity", "Vaccine hesitancy")

# Community stability function
communityStability <- function(data, type, level, iterations)
{
  
  communityMemberships <- list()
  
  for (i in 1:iterations)
  {
    fitGraph <- mgm(data, type, level, k = 2, verbatim = TRUE)
    iGraph<- graph_from_adjacency_matrix(abs
                                         (fitGraph$pairwise$wadj), "undirected", weighted =
                                           TRUE)
    communityMemberships[[i]] <- cluster_walktrap(iGraph)$membership
  }
  
  communityOverlap <- matrix(NA, length(data), length(data))
  
  for(j in 1:length(data))
  {
    
    overlapPerNode <- matrix(NA, iterations, ncol(communityOverlap))
    
    for(k in 1: iterations)
    {
      overlapPerNode[k,] <- as.numeric(communityMemberships[[k]][j] == communityMemberships[[k]])
    }
    
    communityOverlap[j,] <- apply(overlapPerNode, 2, mean)
  }
  
  diag(communityOverlap) <- 0
  
  return(list(communityMemberships = communityMemberships, communityOverlap = communityOverlap))
  
}
```


## Fit model
```{r}
set.seed(1)
FitW3 <- mgm(W3, type, level, k = 2, binarySign = TRUE)
```

## Community stability

```{r}
#function LOAD THE OBJECT down below TO SAVE TIME:
CommunityStabTotal<-communityStability(W3, type, level, it=1000)

#load the object instead:
CommunityStabTotal = readRDS(here("Input", "CommunityStabTotal.rds"))
```

```{r}
# Visualize community stability
pdf(file = '../Output/core/community_stability.pdf',paper = "USr",
    height = 9, width = 12)
qgraph(CommunityStabTotal$communityOverlap, layout = "spring", 
       theme = "Borkulo", labels = shortnames,
       nodeNames = longnames,vsize=4.0,
       edge.labels=FALSE, legend = TRUE, legend.cex = 0.3)
dev.off()

# Vizualise detected communities
inputCommDetection_total<-CommunityStabTotal$communityOverlap
inputCommDetection_total[which(inputCommDetection_total <= .90)] <- 0

pdf(file = '../Output/core/detected_communities.pdf',paper = "USr",
    height = 9, width = 12)
qgraph(inputCommDetection_total, layout = "spring", theme = "Borkulo",
       labels = shortnames, nodeNames = longnames, vsize=4.0,
       edge.labels=FALSE, legend = TRUE, legend.cex = 0.3)
dev.off()
```

```{r}
# group variables based on TH
Totalgroup_comm <- list(
 " "=c(1,4,5,10,19),
 " "=c(3,6,11),
 " "=c(7,9),
 " "=c(2,8,12:18))

# define nice colors
Totalgroup_cols <- c("#4EB64A","#F4AD0A","#54C2F2", "#9370DB")

# TO DO: VISUALIZED ACCORDING TO COM DETECTION
Totalgroup_cols2 <- c("#FBB4AE","#B3CDE3","#CCEBC5","#DECBE4","#FED9A6","#FFFFCC","#E5D8BD","#FDDAEC")
```

## Plot

```{r}
#enables theme colorblind because we don't need to specify edge.color
inputGraphMGM <- FitW3$pairwise$wadj
signsGraphMGM <- FitW3$pairwise$signs
signsGraphMGM[which(is.na(signsGraphMGM))] <- 1
inputGraphMGM <- inputGraphMGM*signsGraphMGM

# refined, no minimum 
set.seed(1)
pdf(file = '../Output/core/MGM_nomin.pdf',paper = "USr", height = 9, width = 12)
GraphMGM<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames, nodeNames = longnames,
  cut = 0.10, maximum = 1, 
  details = FALSE, vsize=6.0,
  groups=Totalgroup_comm, color= Totalgroup_cols,
  legend = TRUE, legend.cex = 0.4, borders = FALSE)
dev.off()

# refined,  minimum = 0.5
pdf(file = '../Output/core/MGM_min_05.pdf',paper = "USr", height = 9, width = 12)
GraphMGM<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames,nodeNames = longnames,
  cut = 0.10, minimum = 0.05, maximum = 1, 
  details = FALSE, vsize=6.0, 
  groups=Totalgroup_comm, color= Totalgroup_cols,
  legend = TRUE, legend.cex = 0.3, borders = FALSE)
dev.off()

# refined,  minimum = 0.10
pdf(file = '../Output/core/MGM_min_10.pdf',paper = "USr", height = 9, width = 12)
GraphMGM<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames,nodeNames = longnames,
  cut = 0.10, minimum = 0.10, maximum = 1, 
  details = FALSE, vsize=6.0, legend = TRUE,
  groups=Totalgroup_comm, color= Totalgroup_cols,
  legend.cex = 0.4, borders = FALSE)
dev.off()
```

## Centrality estimates

```{r}
#graph with complete labels for centrality plot
GraphMGMCENT<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "colorblind",
  labels = longnames, minimum = 0,
  cut = 0.10, maximum = 1, details = TRUE,
  legend = FALSE)

#centrality Total
centMGM <- centralityTable(GraphMGMCENT,standardized = FALSE)

#CentralityPlot Total
centrality_table = centralityPlot(GraphMGMCENT, include = c("Strength"), scale = "raw",
               orderBy = "Strength") + theme_nice() + theme(axis.text.y=element_text(hjust=1))

ggsave(here("Output", "core", "Centrality_Table.jpg"), centrality_table)
```

## ASPL

```{r}
#Shortest Path Lenght
SPLMGM <- centrality(GraphMGM)$ShortestPathLengths
SPLMGM <- SPLMGM[upper.tri(SPLMGM)]
#Average shortest path length
ASPL_MGM <- mean(SPLMGM)
```
ASPL = 13.25838

## Bootstrap

#### Edge accuracy

```{r}
#edge weight accuracy: non parametric bootstrap with 8 cores
edgeacc =  bootnet(W3, nBoots = 1000, nCores = 8, 'mgm')

#load the object instead:
#edgeacc = readRDS(here("Input", "edgeacc.rds"))

#plot 1
pdf('../Output/core/robustness/edge_accuracy.pdf', height = 70, width = 50)
plot(edgeacc, labels = longnames, order = "sample")
dev.off()

#Plot 2
pdf('../Output/core/robustness/edge_accuracy_CI.pdf', height = 70, width = 50)
plot(edgeacc, plot = "interval", split0 = TRUE, order="sample", labels=longnames)
dev.off()

#summary
saummary_edgeacc = summary(edgeacc, statistics = c("edge", "strength"), 
                            perNode = FALSE, rank = FALSE) 
```

#### Centrality stability

```{r}
# case dropping bootstrap
centstab = bootnet(ITA, nBoots = 1000, 'mgm', type = "case", nCores = 8)

#load the object instead:
#centstab = readRDS(here("Input", "centstab.rds"))

#plot 1
pdf('../Output/core/robustness/Centrality_stability.pdf', height = 70, width = 50)
plot(centstab, "Strength", perNode = TRUE, labels = longnames,
     subsetRange = c(100,50))
dev.off()

#Plot 2
pdf('../Output/core/robustness/Centrality_stability_CI.pdf', height = 70, width = 50)
plot(centstab, "Strength", CIstyle =  "quantiles")
dev.off()

#CS-coefficient (result should be above 0.25, better if above 0.5)
corstab = corStability(centstab)
```

#### Testing Edge and centrality differences

```{r}
# Test: difference of weight ties 2-3 vs 4-5
differenceTest(edgeacc, 2--3, 3--4, "strength")

# Plot test results for every edge weight in the network
pdf('../Output/core/robustness/test_edges.pdf', height = 70, width = 50)
plot(edgeacc, "edge", plot = "difference", onlyNonZero = TRUE, order = "sample", 
     labels = T)
dev.off()
```

```{r}
# Test: difference of strength of node 2 vs 3 (if the bootstrapped CI include 0, they do not differ)
differenceTest(edgeacc, 2, 3, "strength")

# Plot test results for every edge weight in the network
pdf('../Output/core/robustness/test_strenghts.pdf', height = 70, width = 50)
plot(edgeacc, "strength", order = "mean", labels = T)
dev.off()
```


## small world

```{r}
#small world network
W3_small_core = smallworldness(mgmFit$pairwise$wadj, B = 1000)
W3_small_core

```
comment: 
- smallworldness > 1 -> small world network
- rnd values > 1 -> small world network
- averagelength_target (Unweighted)

# Output

## Export heavy objects

```{r}
#communities
saveRDS(CommunityStabTotal, here("Input", "CommunityStabTotal.rds"))
#bootnet
saveRDS(edgeacc, here("Input","edgeacc.rds"))
saveRDS(centstab, here("Input", "centstab.rds"))
```

## Edge weight to excel

```{r}
##only upper triangle without edge weigths 0 for readability
EdgeWeight_Total_half<-upper.triangle(inputGraphMGM)
EdgeWeight_Total_half[EdgeWeight_Total_half == 0] <- NA
EdgeWeightsExcel_half<- list("mgm" = EdgeWeight_Total_half)
write.xlsx(EdgeWeightsExcel_half, "../Output/core/EdgeWeightsExcel_half.xlsx",
           colWidths = "auto", rowNames = TRUE)
```

